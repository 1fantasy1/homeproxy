#!/bin/sh /etc/rc.common
# SPDX-License-Identifier: GPL-3.0-only
#
# Copyright (C) 2022 ImmortalWrt.org

USE_PROCD=1

START=99
STOP=10

CONF="homeproxy"
PROG="/usr/bin/sing-box"
TUNNAME="emortal-singbox"

HP_DIR="/etc/homeproxy"
RUN_DIR="/var/run/homeproxy"

FW4="$(command -v fw4)"

log() {
	echo -e "$(date "+%Y-%m-%d %H:%M:%S") [DAEMON] $*" >> "$RUN_DIR/homeproxy.log"
}

start_service() {
	config_load "$NAME"

	local main_server enabled_server
	config_get main_server "config" "main_server" "nil"
	config_get_bool enabled_server "server" "enabled" "0"

	local routing_mode default_outbound
	config_get routing_mode "config" "routing_mode"
	config_get default_outbound "routing" "default_outbound" "nil"

	if [ "$main_server" = "nil" ] && [ "$routing_mode" = "custom" -a "$default_outbound" = "nil" ] && [ "$enabled_server" = "0" ]; then
		return 1
	fi

	mkdir -p "$LOG_DIR"
	"$HP_HOME"/scripts/generate_sing-box.lua

	if [ "$(jsonfilter -i "$RUN_DIR/sing-box.json" -e "@.inbounds")" = "[ ]" ]; then
		log "No valid inbound found, stopping..."
		return 1
	end

	procd_open_instance "sing-box"
	procd_set_param command "$PROG"
	procd_append_param command run --config "$RUN_DIR/sing-box.json"

	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_set_param respawn

	procd_close_instance

	if [ -z "$FW4" ]; then
		mkdir -p "/var/etc/"
		echo "iptables -I FORWARD -o $TUNNAME -j ACCEPT" > "/var/etc/$NAME.include"
		[ -z "$(command -v ip6tables)" ] || echo "ip6tables -I FORWARD -o $TUNNAME -j ACCEPT" >> "/var/etc/$NAME.include"
		sh "/var/etc/$NAME.include"
	fi

	log "$(sing-box version | awk '{print $1,$2}') started."
}

stop_service() {
	if [ -z "$FW4" ]; then
		iptables -D FORWARD -o "$TUNNAME" -j ACCEPT
		[ -z "$(command -v ip6tables)" ] || ip6tables -D FORWARD -o "$TUNNAME" -j ACCEPT
		rm -f "/var/etc/$NAME.include"
	fi
}

reload_service() {
	stop
	start
}

service_triggers() {
	procd_add_reload_trigger "$NAME"
}
